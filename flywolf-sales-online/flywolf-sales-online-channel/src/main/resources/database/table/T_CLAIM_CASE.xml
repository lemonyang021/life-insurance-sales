<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd                               http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="uuid_type" value="RAW(16)" dbms="oracle" />
	<property name="uuid_type" value="BINARY(16)" dbms="mysql" />
	<property name="uuid_type" value="uniqueidentifier" dbms="mssql" />
	<property name="pk" value="PK_CLAIM_CASE" dbms="mssql,oracle,postgresql" />
	<property name="pk" value="PRIMARY" dbms="mysql" />
	<property name="current_datetime" value="sysdate" dbms="oracle" />
	<property name="current_datetime" value="current_timestamp"
		dbms="mssql" />
	<property name="current_datetime" value="now()" dbms="mysql,postgresql" />

	<changeSet author="generated" id="T_CLAIM_CASE">
		<createTable tableName="T_CLAIM_CASE">
			<column name="CASE_ID" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="EXTRA_PROPS" type="VARCHAR(600)" />
			<column name="INSERT_TIME" type="datetime" />
			<column name="INSERT_TIMESTAMP" type="datetime" />
			<column name="INSERTED_BY" type="BIGINT" />
			<column name="UPDATE_TIME" type="datetime" />
			<column name="UPDATE_TIMESTAMP" type="datetime" />
			<column name="UPDATED_BY" type="BIGINT" />
			<column name="CASE_NO" type="VARCHAR(50)" />
			<column name="TENANT_CODE" type="VARCHAR(20)" />
			<column name="INSURER_CODE" type="VARCHAR(40)" />
			<column name="EVENT_TIME" type="datetime" />
			<column name="EVENT_DETAIL" type="VARCHAR(100)" />
			<column name="EVENT_NATURE" type="INT" />
			<column name="CLAIMANT_NAME" type="VARCHAR(100)" />
			<column name="CLAIMANT_EMAIL" type="VARCHAR(50)" />
			<column name="CLAIMANT_MOBILE" type="VARCHAR(20)" />
			<column name="CASE_STATUS" type="INT" />
			<column name="REPORT_TYPE" type="INT" />
			<column name="REPORT_TIME" type="datetime" />
			<column name="SETTLE_TIME" type="datetime" />
			<column name="ACCEPT_TIME" type="datetime" />
			<column name="EVALUATE_TIME" type="datetime" />
			<column name="PAYMENT_TIME" type="datetime" />
			<column name="REJECT_REASON" type="INT" />
			<column name="REJECT_REASON_DESC" type="VARCHAR(400)" />
			<column name="PAY_AMOUNT" type="DECIMAL(18, 2)" />
			<column name="CURRENCY" type="INT" />
		</createTable>
	</changeSet>

	<changeSet author="generated" id="PRIMARY">
		<addPrimaryKey columnNames="CASE_ID" constraintName="${pk}"
			tableName="T_CLAIM_CASE" />
	</changeSet>

	<changeSet author="generated" id="createIndex-claim-tenant">
		<createIndex indexName="idx_claim_tenant" tableName="T_CLAIM_CASE">
			<column name="TENANT_CODE" type="VARCHAR2(20)" />
		</createIndex>
	</changeSet>

	<changeSet author="generated" id="createIndex-caseno">
		<createIndex indexName="idx_case_no" tableName="T_CLAIM_CASE">
			<column name="CASE_NO" type="VARCHAR2(50)" />
		</createIndex>
	</changeSet>

	<changeSet author="xin.shi" id="T_CLAIM_CASE.CLAIMANT_RELA_TO_INSURED"
		runOnChange="true">
		<preConditions onFail="MARK_RAN" onFailMessage="CLAIMANT_RELA_TO_INSURED exists">
			<not>
				<columnExists tableName="T_CLAIM_CASE" columnName="CLAIMANT_RELA_TO_INSURED" />
			</not>
		</preConditions>
		<addColumn tableName="T_CLAIM_CASE">
			<column name="CLAIMANT_RELA_TO_INSURED" type="INT" />
		</addColumn>
	</changeSet>

	<changeSet author="xin.shi" id="T_CLAIM_CASE.CLAIM_TYPE"
		runOnChange="true">
		<preConditions onFail="MARK_RAN" onFailMessage="CLAIM_TYPE exists">
			<not>
				<columnExists tableName="T_CLAIM_CASE" columnName="CLAIM_TYPE" />
			</not>
		</preConditions>
		<addColumn tableName="T_CLAIM_CASE">
			<column name="CLAIM_TYPE" type="INT" />
		</addColumn>
	</changeSet>

	<changeSet author="xin.shi" id="T_CLAIM_CASE.UNI_1">
		<addUniqueConstraint tableName="T_CLAIM_CASE"
			constraintName="UNI_T_CLAIM_CASE_1" columnNames="INSURER_CODE,CASE_NO" />
	</changeSet>

	<changeSet author="xin.shi" id="T_CLAIM_CASE.NOTIFICATION_AMOUNT"
		runOnChange="true">
		<preConditions onFail="MARK_RAN" onFailMessage="NOTIFICATION_AMOUNT exists">
			<not>
				<columnExists tableName="T_CLAIM_CASE" columnName="NOTIFICATION_AMOUNT" />
			</not>
		</preConditions>
		<addColumn tableName="T_CLAIM_CASE">
			<column name="NOTIFICATION_AMOUNT" type="DECIMAL(18, 2)" />
		</addColumn>
	</changeSet>

	<changeSet author="xin.shi" id="T_CLAIM_CASE.INSURED_PARTY_ID"
		runOnChange="true">
		<preConditions onFail="MARK_RAN" onFailMessage="INSURED_PARTY_ID exists">
			<not>
				<columnExists tableName="T_CLAIM_CASE" columnName="INSURED_PARTY_ID" />
			</not>
		</preConditions>
		<addColumn tableName="T_CLAIM_CASE">
			<column name="INSURED_PARTY_ID" type="BIGINT" />
		</addColumn>
	</changeSet>

	<changeSet author="xin.shi" id="T_CLAIM_CASE.PAY_AMOUNT.CHANGE"
		runOnChange="true">
		<modifyDataType columnName="PAY_AMOUNT" newDataType="DECIMAL(18, 6)"
			tableName="T_CLAIM_CASE" />
	</changeSet>
	
	<changeSet author="yanzhang.chen" id="T_CLAIM_CASE.EVENT_DETAIL.600"
		runOnChange="true">
		<modifyDataType columnName="EVENT_DETAIL" newDataType="VARCHAR(600)"
			tableName="T_CLAIM_CASE" />
	</changeSet>
	
	<changeSet author="generated" id="T_CLAIM_CASE.TENANT_CODE.changeLength">
      <modifyDataType tableName="T_CLAIM_CASE" columnName="TENANT_CODE" newDataType="VARCHAR2(60)"/>
    </changeSet>

  <changeSet author="xin.shi" id="modify claimant mobile and mail length" >
    <modifyDataType columnName="CLAIMANT_EMAIL"
      newDataType="VARCHAR2(200)" tableName="T_CLAIM_CASE" />
    <modifyDataType columnName="CLAIMANT_MOBILE"
      newDataType="VARCHAR2(80)" tableName="T_CLAIM_CASE" />
  </changeSet>
  <changeSet author="xin.shi" id="add claimant mobile and mail encrypt" dbms='mysql'>
    <sql endDelimiter=";" stripComments="true">SET @@session.block_encryption_mode:='aes-256-cbc';</sql>
    <update 
      tableName="T_CLAIM_CASE">
      <column name="CLAIMANT_EMAIL" valueComputed="CONCAT('{{##AES##}}',TO_BASE64(AES_ENCRYPT(CLAIMANT_EMAIL, '${aes256key}', '${aes256iv}')))" />
      <where>LEFT(CLAIMANT_EMAIL,11) != '{{##AES##}}'</where>
    </update>
    <update 
      tableName="T_CLAIM_CASE">
      <column name="CLAIMANT_MOBILE" valueComputed="CONCAT('{{##AES##}}',TO_BASE64(AES_ENCRYPT(CLAIMANT_MOBILE, '${aes256key}', '${aes256iv}')))" />
      <where>LEFT(CLAIMANT_MOBILE,11) != '{{##AES##}}'</where>
    </update>
  </changeSet>
</databaseChangeLog>
